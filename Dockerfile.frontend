FROM php:8.2-fpm-alpine

RUN apk update && apk add --no-cache \
    nginx \
    php-mysqli \
    php-pdo_mysql \
    php-json \
    && rm -rf /var/cache/apk/*

WORKDIR /var/www/html

# Clean existing Nginx configs
RUN rm -f /etc/nginx/conf.d/*

# ✔ Create conf directory
RUN mkdir -p /etc/nginx/conf.d

# ✔ Proper nginx.conf
RUN echo "user nginx; \
worker_processes auto; \
\
events { worker_connections 1024; } \
\
http { \
    include /etc/nginx/mime.types; \
    default_type application/octet-stream; \
    sendfile on; \
    include /etc/nginx/conf.d/*.conf; \
}" > /etc/nginx/nginx.conf
# ✔ Default site config
RUN echo "server { \
    listen 80; \
    root /var/www/html; \
    index index.php; \
    location / { try_files \$uri \$uri/ /index.php; } \
    location ~ \.php\$ { \
        fastcgi_pass 127.0.0.1:9000; \
        fastcgi_index index.php; \
        include fastcgi_params; \
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name; \
    } \
}" > /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["sh", "-c", "php-fpm & nginx -g 'daemon off;'"]

